// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ---------------  ENUMS (used everywhere)  ---------------
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Currency {
  NPR
  USD
}

enum FeeType {
  GOVERNMENT
  SERVICE
  PENALTY
  TAX
}

enum DocType {
  ORIGINAL
  PHOTOCOPY
  PHOTOGRAPH
  PRINTOUT
  NOTARIZED
  CERTIFIED_COPY
}

enum OfficeType {
  // District Level - Core Services (77 offices each)
  DISTRICT_ADMINISTRATION_OFFICE    // DAO - Citizenship, recommendations, certificates
  LAND_REVENUE_OFFICE              // Malpot - Land registration, ownership transfer
  DISTRICT_EDUCATION_OFFICE        // SEE/SLC verification, certificate attestation
  
  // Transport Services
  TRANSPORT_MANAGEMENT_OFFICE      // Vehicle registration, blue book, license
  DRIVING_LICENSE_OFFICE           // License tests and renewals
  
  // Local Government - Daily services (753 offices)
  MUNICIPALITY_OFFICE              // Nagarpalika - Local services, business tax
  RURAL_MUNICIPALITY_OFFICE        // Gaupalika - Rural local services
  
  // Ward Level - Highest volume (6,743 offices)
  WARD_OFFICE                      // Birth/death registration, business registration, recommendations
  
  // Travel & Immigration
  PASSPORT_OFFICE                  // Passport applications and renewals
  IMMIGRATION_OFFICE               // Visa, travel documents
  
  // Business Registration - Federal Level
  OFFICE_OF_COMPANY_REGISTRAR      // OCR - Company registration (e-OCR/CAMIS)
  COTTAGE_SMALL_INDUSTRY_OFFICE    // DCSI - Cottage/small industry registration
  INLAND_REVENUE_OFFICE            // IRD - PAN/VAT registration, tax filing
  
  // Social Services - NEWLY ADDED
  LABOUR_OFFICE                    // Foreign employment, work permits, labor disputes
}

enum WeekDay {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// ---------------  HIERARCHICAL LOCATION  ---------------
model Province {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  nameNep   String?
  slug      String     @unique
  districts District[]
  offices   ProvinceOffice[] 
}

model District {
  id             Int            @id @default(autoincrement())
  provinceId     Int
  name           String         @unique
  nameNep        String?
  slug           String         @unique
  province       Province       @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  municipalities Municipality[]
  offices        DistrictOffice[]       // Add this
}

model Municipality {
  id         Int        @id @default(autoincrement())
  districtId Int
  name       String
  nameNep    String?
  slug       String
  type       String     @default("Municipality")
  district   District   @relation(fields: [districtId], references: [id], onDelete: Cascade)
  wards      Ward[]
  offices    MunicipalityOffice[] // Add this

  @@unique([districtId, slug])
}


model Ward {
  id             Int            @id @default(autoincrement())
  municipalityId Int
  wardNumber     Int
  municipality   Municipality  @relation(fields: [municipalityId], references: [id], onDelete: Cascade)
  offices        WardOffice[]

  @@unique([municipalityId, wardNumber])
}

// ---------------  TOP-LEVEL SERVICE TREE  ---------------
model Service {
  id              String   @id @default(cuid())
  serviceId       String   @unique // service_001 â€¦
  name            String
  slug            String   @unique
  category        String
  description     String
  eligibility     String
  validityPeriod  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  subServices SubService[]
  metadata    ServiceMetadata?

  @@index([slug])
  @@index([category])
  @@index([serviceId])
}

model ServiceMetadata {
  id          String   @id @default(cuid())
  serviceId   String   @unique
  lastUpdated DateTime @default(now())
  version     String
  dataSource  String
  verifiedBy  String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

// ---------------  SUB-SERVICE  ---------------
model SubService {
  id              String   @id @default(cuid())
  // subServiceId    String   @unique
  serviceId       String
  name            String
  slug            String   @unique
  description     String
  priority        Priority @default(MEDIUM)
  isOnlineEnabled Boolean  @default(false)
  onlinePortalUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  service      Service              @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceSteps ServiceStep[]
  detailedProc DetailedProc?
  offices      SubServiceOnOffice[]

  @@index([serviceId])
  @@index([isOnlineEnabled])
}

// ---------------  STEP (inside subService)  ---------------
model ServiceStep {
  id                  String     @id @default(cuid())
  subServiceId        String
  step                Int
  stepTitle           String
  stepDescription     String
  officeType          OfficeType
  requiresAppointment Boolean    @default(false)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  subService             SubService        @relation(fields: [subServiceId], references: [id], onDelete: Cascade)
  documentsRequired      StepDocument[]
  totalFees              StepFee[]
  
  timeRequired           StepTimeRequired?
  workingHours           WorkingHours[]
  responsibleAuthorities StepAuthority[] @relation("ResponsibleAuthority")
  complaintAuthorities   StepAuthority[] @relation("ComplaintAuthority")

  @@index([subServiceId])
  @@index([officeType])
}

// ---------------  DOCUMENT (per step)  ---------------
model StepDocument {
  id                   Int @id @default(autoincrement())
  serviceStepId        String
  docId                String
  name                 String
  nameNepali           String
  type                 DocType
  quantity             Int
  format               String
  isMandatory          Boolean     @default(true)
  notes                String?
  relatedService       String? // slug reference to the related service/sub-service
  alternativeDocuments String[]
  step                 ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)

  @@unique([serviceStepId, docId]) // no duplicate docs per step
}

// ---------------  FEE (per step)  ---------------
model StepFee {
  id                  Int      @id @default(autoincrement())
  serviceStepId       String
  feeId               String
  feeTitle            String
  feeTitleNepali      String?
  feeAmount           Float
  currency            Currency @default(NPR)
  feeType             FeeType
  isRefundable        Boolean  @default(false)
  applicableCondition String?
  notes               String?
  step                ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)

  @@unique([serviceStepId, feeId])  // Prevent duplicate fees per step
}

// ---------------  TIME (per step)  ---------------
model StepTimeRequired {
   id                   Int @id @default(autoincrement())
  serviceStepId      String      @unique
  minimumTime        String
  maximumTime        String
  averageTime        String
  remarks            String?
  expeditedAvailable Boolean     @default(false)
  workingDaysOnly    Boolean     @default(true)
  step               ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)
}

// ---------------  AUTHORITY (resp & complaint)  ---------------
model StepAuthority {
   id                   Int @id @default(autoincrement())
  responsibleStepId String?
  complaintStepId String?
  position         String
  positionNepali   String?
  department       String
  contactNumber    String
  email            String?
  complaintProcess String?
  isResp           Boolean // true = responsible, false = complaint

  responsibleForStep ServiceStep? @relation("ResponsibleAuthority", fields: [responsibleStepId], references: [id], onDelete: Cascade)
  complaintForStep ServiceStep? @relation("ComplaintAuthority", fields: [complaintStepId], references: [id], onDelete: Cascade)
}

// ---------------  WORKING HOURS (per step)  ---------------
model WorkingHours {
   id                   Int @id @default(autoincrement())
  serviceStepId String
  day           WeekDay
  openClose     String // "10:00 AM - 5:00 PM"
  step          ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)
  @@unique([serviceStepId, day])  // One entry per day per step
}

// ---------------  DETAILED PROCEDURE  ---------------
model DetailedProc {
  id              String     @id @default(cuid())
  subServiceId    String     @unique
  overview        String
    overviewNepali  String?
  stepByStepGuide String[]
  importantNotes  String[]
  legalReferences Json[] // {lawName, section, url}
  faqs            Json[] // {question, answer}
  commonIssues    Json[] // {issue, solution}
  subService      SubService @relation(fields: [subServiceId], references: [id], onDelete: Cascade)
}

// ---------------  OFFICE (linked to Ward + OfficeCategory)  ---------------
model OfficeCategory {
  id          String   @id @default(cuid())
  name        String   @unique // maps to officeType enum
  description String?
  offices     Office[]
}

model Office {
  id               String     @id @default(cuid())
  officeId         String     @unique
  categoryId       String
  name             String
    nameNepali       String?
  type             OfficeType
  address          String
    addressNepali    String?
  contact          String?
  alternateContact String?
  email            String?
  website          String?
  photoUrls        String[]
  facilities       String[]
  nearestLandmark  String?
  publicTransport  String?
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  wardOffices         WardOffice[]
  municipalityOffices MunicipalityOffice[]
  districtOffices     DistrictOffice[]
  provinceOffices     ProvinceOffice[]

  category    OfficeCategory       @relation(fields: [categoryId], references: [id])
  subServices SubServiceOnOffice[]
  ratings     OfficeRating?
}

// Explicit junction tables
model WardOffice {
  officeId String @unique
  wardId   Int
  office   Office @relation(fields: [officeId], references: [id], onDelete: Cascade)
  ward     Ward   @relation(fields: [wardId], references: [id], onDelete: Cascade)
}

model MunicipalityOffice {
  officeId       String       @unique
  municipalityId Int
  office         Office       @relation(fields: [officeId], references: [id], onDelete: Cascade)
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)
}

model DistrictOffice {
  officeId   String   @unique
  districtId Int
  office     Office   @relation(fields: [officeId], references: [id], onDelete: Cascade)
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)
}

model ProvinceOffice {
  officeId   String   @unique
  provinceId Int
  office     Office   @relation(fields: [officeId], references: [id], onDelete: Cascade)
  province   Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)
}

model OfficeRating {
  id            String @id @default(cuid())
  officeId      String @unique
  averageRating Float
  totalReviews  Int
  office        Office @relation(fields: [officeId], references: [id], onDelete: Cascade)
}

// many-to-many between SubService and Office (with dynamicData flag)
model SubServiceOnOffice {
  id            String  @id @default(cuid())
  subServiceId  String
  officeId      String
  locationBased Boolean @default(true)
  fetchFromAPI  Boolean @default(true)
  apiEndpoint   String?
  remarks       String?

  subService SubService @relation(fields: [subServiceId], references: [id], onDelete: Cascade)
  office     Office     @relation(fields: [officeId], references: [id], onDelete: Cascade)

  @@unique([subServiceId, officeId])
}

// ---------------  USER ADDRESS (optional)  ---------------
model User {
  id           String   @id @default(cuid())
  phone        String
  name         String?
  locationCode String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
