// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ---------------  ENUMS (used everywhere)  ---------------
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Currency {
  NPR
  USD
}

enum FeeType {
  GOVERNMENT
  SERVICE
  PENALTY
  TAX
}

enum DocType {
  ORIGINAL
  PHOTOCOPY
  PHOTOGRAPH
  PRINTOUT
  NOTARIZED
  CERTIFIED_COPY
}

enum OfficeType {
  // District Level - Core Services (77 offices each)
  DISTRICT_ADMINISTRATION_OFFICE // DAO - Citizenship, recommendations, certificates
  LAND_REVENUE_OFFICE // Malpot - Land registration, ownership transfer
  DISTRICT_EDUCATION_OFFICE // SEE/SLC verification, certificate attestation

  // Transport Services
  TRANSPORT_MANAGEMENT_OFFICE // Vehicle registration, blue book, license
  DRIVING_LICENSE_OFFICE // License tests and renewals

  // Local Government - Daily services (753 offices)
  MUNICIPALITY_OFFICE // Nagarpalika - Local services, business tax
  RURAL_MUNICIPALITY_OFFICE // Gaupalika - Rural local services

  // Ward Level - Highest volume (6,743 offices)
  WARD_OFFICE // Birth/death registration, business registration, recommendations

  // Travel & Immigration
  PASSPORT_OFFICE // Passport applications and renewals
  IMMIGRATION_OFFICE // Visa, travel documents

  // Business Registration - Federal Level
  OFFICE_OF_COMPANY_REGISTRAR // OCR - Company registration (e-OCR/CAMIS)
  COTTAGE_SMALL_INDUSTRY_OFFICE // DCSI - Cottage/small industry registration
  INLAND_REVENUE_OFFICE // IRD - PAN/VAT registration, tax filing

  // Social Services - NEWLY ADDED
  LABOUR_OFFICE // Foreign employment, work permits, labor disputes
}

enum WeekDay {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// ---------------  HIERARCHICAL LOCATION  ---------------
model Province {
  id        Int              @id @default(autoincrement())
  code      String?          @unique // "P1" "P2"
  name      String           @unique
  nameNep   String?
  slug      String           @unique
  districts District[]
  offices   ProvinceOffice[]
}

model District {
  id             Int              @id @default(autoincrement())
  provinceId     Int
  name           String           @unique
  nameNep        String?
  slug           String           @unique
  province       Province         @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  municipalities Municipality[]
  offices        DistrictOffice[] // Add this
}

model Municipality {
  id         Int                  @id @default(autoincrement())
  districtId Int
  name       String
  nameNep    String?
  slug       String
  type       String               @default("Municipality")
  district   District             @relation(fields: [districtId], references: [id], onDelete: Cascade)
  wards      Ward[]
  offices    MunicipalityOffice[] // Add this

  @@unique([districtId, slug])
}

model Ward {
  id             Int          @id @default(autoincrement())
  municipalityId Int
  wardNumber     Int
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)
  offices        WardOffice[]

  @@unique([municipalityId, wardNumber])
}

model Service {
  id        String @id @default(cuid())
  serviceId String @unique

  // Hierarchy fields
  parentId String? // NULL = root service
  level    Int     @default(0) // 0 = root, 1 = child, 2 = grandchild, etc.

  // Basic info
  name        String
  slug        String
  categories  ServiceCategory[]
  description String?

  // Service metadata
  priority        Priority?
  isOnlineEnabled Boolean   @default(false)
  onlinePortalUrl String?

  // Eligibility & validity
  eligibility    String?
  validityPeriod String?

  // Self-referential relations
  parent   Service?  @relation("ServiceHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Service[] @relation("ServiceHierarchy")

  // Service steps (only leaf services have steps)
  serviceSteps ServiceStep[]

  // Detailed procedure (only leaf services)
  detailedProc DetailedProc?

  // Metadata
  metadata ServiceMetadata?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([parentId, slug]) // Unique slug within same parent
  @@index([parentId])
  @@index([slug])
  @@index([level])
}

model Category {
  id          String            @id @default(cuid())
  name        String            @unique
  slug        String            @unique
  description String?
  icon        String?
  color       String?
  services    ServiceCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt //
}

model ServiceCategory {
  id         String   @id @default(cuid())
  serviceId  String
  categoryId String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceId, categoryId])
  @@index([serviceId])
  @@index([categoryId])
}

model ServiceMetadata {
  id          String   @id @default(cuid())
  serviceId   String   @unique
  lastUpdated DateTime @default(now())
  version     String?
  dataSource  String?
  verifiedBy  String?
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

// ---------------  STEP (inside service)  ---------------
model ServiceStep {
  id                  String       @id @default(cuid())
  serviceId           String
  step                Int
  stepTitle           String
  stepDescription     String
  officeTypes         OfficeType[] // Changed from single officeType to array
  requiresAppointment Boolean      @default(false)
  isOnline            Boolean      @default(false) // NEW: If true, this step is completed online
  onlineFormUrl       String?      // NEW: URL to online form/portal for this step
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  service           Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  documentsRequired StepDocument[]
  totalFees         StepFee[]

  timeRequired           StepTimeRequired?
  workingHours           WorkingHours[]
  responsibleAuthorities StepAuthority[]   @relation("ResponsibleAuthority")
  complaintAuthorities   StepAuthority[]   @relation("ComplaintAuthority")

  @@unique([serviceId, step])
  @@index([serviceId])
}

// ---------------  DOCUMENT (per step)  ---------------
model StepDocument {
  id                   Int         @id @default(autoincrement())
  serviceStepId        String
  docId                String
  name                 String
  nameNepali           String
  type                 DocType
  quantity             Int
  format               String
  isMandatory          Boolean     @default(true)
  notes                String?
  relatedService       String? // slug reference to the related service/sub-service
  alternativeDocuments String[]
  step                 ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)

  @@unique([serviceStepId, docId]) // no duplicate docs per step
}

// ---------------  FEE (per step)  ---------------
model StepFee {
  id                  Int         @id @default(autoincrement())
  serviceStepId       String
  feeId               String
  feeTitle            String
  feeTitleNepali      String?
  feeAmount           Float
  currency            Currency    @default(NPR)
  feeType             FeeType
  isRefundable        Boolean     @default(false)
  applicableCondition String?
  notes               String?
  step                ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)

  @@unique([serviceStepId, feeId]) // Prevent duplicate fees per step
}

// ---------------  TIME (per step)  ---------------
model StepTimeRequired {
  id                 Int         @id @default(autoincrement())
  serviceStepId      String      @unique
  minimumTime        String
  maximumTime        String
  averageTime        String
  remarks            String?
  expeditedAvailable Boolean     @default(false)
  workingDaysOnly    Boolean     @default(true)
  step               ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)
}

// ---------------  AUTHORITY (resp & complaint)  ---------------
model StepAuthority {
  id                Int     @id @default(autoincrement())
  responsibleStepId String?
  complaintStepId   String?
  position          String
  positionNepali    String?
  department        String
  contactNumber     String
  email             String?
  complaintProcess  String?
  isResp            Boolean // true = responsible, false = complaint

  responsibleForStep ServiceStep? @relation("ResponsibleAuthority", fields: [responsibleStepId], references: [id], onDelete: Cascade)
  complaintForStep   ServiceStep? @relation("ComplaintAuthority", fields: [complaintStepId], references: [id], onDelete: Cascade)
}

// ---------------  WORKING HOURS (per step)  ---------------
model WorkingHours {
  id            Int         @id @default(autoincrement())
  serviceStepId String
  day           WeekDay
  openClose     String // "10:00 AM - 5:00 PM"
  step          ServiceStep @relation(fields: [serviceStepId], references: [id], onDelete: Cascade)

  @@unique([serviceStepId, day]) // One entry per day per step
}

// ---------------  DETAILED PROCEDURE  ---------------
model DetailedProc {
  id              String   @id @default(cuid())
  serviceId       String   @unique
  overview        String
  overviewNepali  String?
  stepByStepGuide String[]
  importantNotes  String[]
  legalReferences Json[] // {lawName, section, url}
  faqs            Json[] // {question, answer}
  commonIssues    Json[] // {issue, solution}
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

// ---------------  OFFICE (linked to Ward + OfficeCategory)  ---------------
model OfficeCategory {
  id          String   @id @default(cuid())
  name        String   @unique // maps to officeType enum
  description String?
  offices     Office[]
}

model Office {
  id               String     @id @default(cuid())
  officeId         String     @unique
  categoryId       String
  name             String
  nameNepali       String?
  type             OfficeType
  address          String
  mapUrl          String?
  addressNepali    String?
  contact          String?
  alternateContact String?
  email            String?
  website          String?
  photoUrls        String[]
  facilities       String[]
  nearestLandmark  String?
  publicTransport  String?
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  wardOffices         WardOffice[]
  municipalityOffices MunicipalityOffice[]
  districtOffices     DistrictOffice[]
  provinceOffices     ProvinceOffice[]

  category OfficeCategory @relation(fields: [categoryId], references: [id])
  ratings  OfficeRating?

  @@index([type])
  @@index([isActive])
  @@index([categoryId])
}

// Explicit junction tables
model WardOffice {
  officeId String @unique
  wardId   Int
  office   Office @relation(fields: [officeId], references: [id], onDelete: Cascade)
  ward     Ward   @relation(fields: [wardId], references: [id], onDelete: Cascade)

  @@index([wardId])
}

model MunicipalityOffice {
  officeId       String       @unique
  municipalityId Int
  office         Office       @relation(fields: [officeId], references: [id], onDelete: Cascade)
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)

  @@index([municipalityId])
}

model DistrictOffice {
  officeId   String   @unique
  districtId Int
  office     Office   @relation(fields: [officeId], references: [id], onDelete: Cascade)
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  @@index([districtId])
}

model ProvinceOffice {
  officeId   String   @unique
  provinceId Int
  office     Office   @relation(fields: [officeId], references: [id], onDelete: Cascade)
  province   Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)

  @@index([provinceId])
}

model OfficeRating {
  id            String @id @default(cuid())
  officeId      String @unique
  averageRating Float
  totalReviews  Int
  office        Office @relation(fields: [officeId], references: [id], onDelete: Cascade)
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id    String  @id @default(cuid())
  username String @unique
  passwordHash String 
  role UserRole @default(USER)
  refreshToken String?

  // Permanent Address (for official documents like citizenship, passport)
  permanentProvinceId      Int?
  permanentDistrictId      Int?
  permanentMunicipalityId  Int?
  permanentWardId          Int?
  permanentLocationCode    String? // Legacy field for backward compatibility

  // Convenient Address (for general services, local offices)
  convenientProvinceId     Int?
  convenientDistrictId     Int?
  convenientMunicipalityId Int?
  convenientWardId         Int?
  convenientLocationCode   String? // Legacy field for backward compatibility

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([permanentLocationCode])
  @@index([convenientLocationCode])
  @@index([permanentDistrictId])
  @@index([convenientDistrictId])
}

